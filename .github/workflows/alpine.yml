name: build alpine mini rootfs with part tool(growpart/resize2fs)

# Controls when the action will run.
on:
  # Triggers the workflow on push on the master branch
  push:
    branches:
      - master
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  schedule:
    - cron: "50 4 * * 4"

jobs:
  Build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: build
        id: build
        run: |
          set -ex
          cd $GITHUB_WORKSPACE && chmod +x ./scripts/*.sh && mkdir -p /dev/shm/output || true
          sudo -E apt update -y
          sudo -E apt-get install -y curl tar gzip xz-utils dpkg parted fdisk util-linux dosfstools e2fsprogs xorriso grub-pc-bin grub-efi-amd64-bin mtools upx
          sudo -E bash -c './scripts/build_alpine_rootfs.sh && cp -f /dev/shm/alpine-part-rootfs.tar.gz /dev/shm/output'
          sudo -E bash -c './scripts/build.sh -k "https://github.com/key2p/IPQ/releases/download/6.17_cloud/linux-image-6.17.7-x64v3-xanmod1_6.17.7-2_amd64.deb" -a "v3" --all && cp -f /dev/shm/cache/dist/* /dev/shm/output'
          sudo -E bash -c './scripts/build.sh -k "https://github.com/key2p/IPQ/releases/download/6.17_cloud/linux-image-6.17.7-x64v2-xanmod1_6.17.7-1_amd64.deb" -a "v2" --all && cp -f /dev/shm/cache/dist/* /dev/shm/output'
          sudo -E chmod -R 0777 /dev/shm/output && ls -al /dev/shm/cache/dist
          echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
          echo "ALPINE_VER=$(cat /dev/shm/alpine_version)" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload Firmware To Release
        if: steps.build.outputs.status == 'success'
        uses: ncipollo/release-action@v1
        with:
          name: R${{ env.DATE }} alpine mini rootfs
          allowUpdates: true
          tag: alpine-rootfs
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: /dev/shm/output/*
          body: |
            **This is alpine mini rootfs for  ${{ env.ALPINE_VER }}**
            ### ğŸ“’ å›ºä»¶ä¿¡æ¯(x86_64ç‰ˆæœ¬)
            - ğŸš€ æ—¥æœŸ: ${{ env.DATE }}
            - ğŸš€ ç‰ˆæœ¬: ${{ env.ALPINE_VER }}
